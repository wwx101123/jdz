<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="__WCSS__/base.css">
    <link rel="stylesheet" type="text/less" href="__WCSS__/comment/mytask.less">
    <script type="text/javascript" src="__WJS__/reset.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.2.2/vue.min.js"></script>
    <script src="https://cdn.bootcss.com/less.js/3.0.4/less.min.js"></script>
    <script type="text/javascript" src="__WJS__/comment/bscroll.min.js"></script>
    <script type="text/javascript" src="__WJS__/comment/vue-resource.js"></script>
    <title>我的参与</title>
    <style>
    @font-face {
        font-family: 'iconfont';  /* project id 803693 */
        src: url('//at.alicdn.com/t/font_803693_utrulktu2oa.eot');
        src: url('//at.alicdn.com/t/font_803693_utrulktu2oa.eot?#iefix') format('embedded-opentype'),
        url('//at.alicdn.com/t/font_803693_utrulktu2oa.woff') format('woff'),
        url('//at.alicdn.com/t/font_803693_utrulktu2oa.ttf') format('truetype'),
        url('//at.alicdn.com/t/font_803693_utrulktu2oa.svg#iconfont') format('svg');
    }
    .iconfont {
        font-family:"iconfont" !important;
        font-style:normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
</style>
</head>
<body>
    <div class="wrap"  id="app">
        <!-- 头部 -->
        <div class="header" ref="header">
            <i class="iconfont back" @click="handelToBack">&#xe682;</i>
                <p v-if="model==1">我的点子</p>
                <p v-else>我的问题</p>
        </div>
        <!-- 内容列表 -->
        <div class="main wrapper" ref="wrapper" :style="{ height: scrollHeight +'px'}">
            <ul class="list imgList" >
                <li class="item" v-for="item in questionList" @click="handelToQuestion(item.id)">
                    <div class="item-con">
                        <p class="mesg">{{item.title}}</p>
                        <div>
                            <img  v-if="item.thumbnail" :src="item.thumbnail" alt="">
                        </div>
                    </div>
                    <p class="item-agree" v-if="item.pv">{{item.pv}}热度</p>
                </li>
                <div v-if="!moreLoadData" class="nomoredata">没有更多数据了...</div>
            </ul>
        </div>
    </div>
    <script>
       var vm = new Vue({
            el: '#app',
            data: {
                questionList:[
                    
                ],
                page:0,
                /* 上拉是否有更多数据 */
                moreLoadData:true,
                /* 滚动高度 */
                scrollHeight:0,
                /* 加载锁 */
                lock:false,
                model:1,//1参与 2提问
            },
            mounted(){
                let model = this.getQueryString("model");
                this.model = model;
                this.scrollHeights();
                /* 初始化数据 */
                this.initData();
            },
            methods: {
                /* 初始化数据 */
                initData(){
                    this.$http.post('./userQA',{model:this.model,page:this.page},{emulateJSON : true}).then((response)=>{
                        console.log(response.data);
                        if(response.data.length>0){
                            this.page++;
                            this.questionList = response.data;
                        }
                        let conHeight = $(".list").height();
                        let scroll = $(".main").height();
                        if(scroll > conHeight){
                            this.loadData();
                        }
                        /* 设置图片 */
                        this.$nextTick(()=>{
                            this.getNaturalSize();
                        })
                    })
                    this.$nextTick(() => {
                        if (!this.scroll) {
                            this.scroll = new BScroll(this.$refs.wrapper, {
                                click:true,
                                // scrollY: true,
                                /* 上拉加载 */
                                pullUpLoad: {
                                    threshold: -40,
                                }
                            })
                           /* 上拉加载 */
                            this.scroll.on('pullingUp', (e) => {
                                this.loadData();
                                this.scroll.finishPullUp();
                                this.getNaturalSize();
                            })
                        }
                    })
                },
                /* 上拉加载 */
                loadData() {
                    if(this.lock){
                        return 
                    }
                    this.lock = true;
                    this.$http.post('./userQA',{model:this.model,page:this.page},{emulateJSON : true}).then((response)=>{
                        console.log(response.data);
                        if(response.data.length>0){
                            this.moreLoadData = true;
                            this.page++;
                            this.questionList = this.questionList.concat(response.data);
                        }else{
                            this.moreLoadData = false;
                        }
                        this.lock = false;
                    })
                    this.scroll.refresh();
                },
                /* 到详情页 */
                handelToQuestion(id){
                    location.href = "./question.html?id="+id;
                },
                /* 设置滚动内容高度函数 */
                scrollHeights(){
                    let _this = this;
                    setTimeout(function(){
                        let header = $(".header").height();
                        let con = $(window).height();
                        let l = con - header  -5;
                        _this.scrollHeight = l;
                    })
                   
                },
                /* 返回 */
                handelToBack(){
                    history.go(-1);
                },
                /* 获取参数 */
                getQueryString(name) {
                    var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
                    var r = window.location.search.substr(1).match(reg);  //这里返回找到正则的匹配
                    if (r != null) {
                        return unescape(r[2]);    //这里返回对应的值

                    }
                    return null;
                },
                /* 获取图片宽高 */
                getNaturalSize() {
                    let s = $(".imgList img");
                    let length = $(".imgList img").length;
                    for(let i = 0;i < length;i++){
                        let src = s[i].src;
                        var img=new Image();
                        img.src = src;
                        var realWidth = img.width;
                        var realHeight = img.height;
                        if(realWidth > realHeight){
                            $(s[i]).addClass("imgWidth");
                            $(s[i]).parent('div').addClass("widthWrap"); 
                        }else{
                            $(s[i]).addClass("imgHeight");  
                            $(s[i]).parent('div').addClass("heightWrap");
                        }
                    }
                }
            }
        })
    </script>
</body>
</html>